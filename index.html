<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Story Reference Explorer</title>
  <style>
    :root {
      --bg: #121417;
      --panel: #1a1f24;
      --muted: #8b97a3;
      --text: #e6edf3;
      --accent: #3aa675;
      --danger: #e05353;
      --border: #2a3138;
      --focus: #7cc7ff;
      --chip: #0e1114;
    }
    * { box-sizing: border-box; }
    html, body, #app { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    a { color: #9bd8ff; }
    .error-banner {
      display: none;
      position: sticky;
      top: 0;
      z-index: 10000;
      background: var(--danger);
      color: #0b0e11;
      padding: 10px 16px;
      font-weight: 600;
    }
    .error-banner.show { display: block; }
    .error-banner button {
      float: right;
      background: transparent;
      border: 0;
      color: #0b0e11;
      font-size: 18px;
      cursor: pointer;
    }
    header {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.3px;
    }
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .pill {
      background: var(--chip);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .input {
      display: inline-flex;
      align-items: center;
      background: #0e1216;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 8px;
      gap: 8px;
    }
    .input input[type="text"] {
      background: transparent;
      border: 0;
      color: var(--text);
      outline: none;
      min-width: 240px;
    }
    .btn {
      background: var(--accent);
      color: #07130d;
      border: 0;
      border-radius: 8px;
      padding: 8px 10px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn.secondary {
      background: #29323a;
      color: var(--text);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    .btn[disabled] { opacity: 0.5; cursor: not-allowed; }
    #layout {
      display: grid;
      grid-template-columns: 360px 1fr;
      grid-template-rows: auto 1fr;
      grid-template-areas:
        "sidebar map"
        "sidebar bottom";
      height: calc(100% - 56px);
    }
    #sidebar {
      grid-area: sidebar;
      overflow: auto;
      border-right: 1px solid var(--border);
      background: #0f1216;
    }
    #map {
      grid-area: map;
      height: 60vh;
      min-height: 360px;
    }
    #bottom {
      grid-area: bottom;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      padding: 12px;
      min-height: 320px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
    }
    .panel h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .kv { font-size: 12px; color: var(--muted); }
    .scroll {
      max-height: 180px;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px;
      background: #0e1216;
    }
    .searchbox {
      width: 100%;
      margin-bottom: 6px;
    }
    .searchbox input {
      width: 100%;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 8px;
      border-radius: 6px;
    }
    .list-item {
      display: flex;
      gap: 6px;
      align-items: center;
      padding: 2px 0;
      font-size: 13px;
    }
    label.checkbox {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    input[type="checkbox"] { accent-color: var(--accent); }
    .slider { margin: 8px 0 2px; }
    .small { font-size: 12px; color: var(--muted); }
    .chart-wrap { height: 260px; }
    .footer-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-top: 1px solid var(--border);
      background: #0e1114;
    }
    .stat { font-size: 12px; color: var(--muted); }
    .legend { font-size: 12px; color: var(--muted); }
    /* noUiSlider dark tweaks */
    .noUi-target {
      background: #11161b;
      border: 1px solid var(--border);
      box-shadow: none;
    }
    .noUi-connect { background: var(--accent); }
    .noUi-handle {
      background: #f2f6f9;
      border: 1px solid #d5dde5;
      box-shadow: none;
      border-radius: 7px;
      width: 14px;
      height: 14px;
      top: -4px;
    }
    .noUi-horizontal { height: 8px; }
    .vis-note { font-size: 12px; color: var(--muted); }
    .hidden { display: none !important; }
    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-width: 700px;
      max-height: 80vh;
      overflow: auto;
      padding: 20px;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px; right: 14px;
      background: transparent;
      border: 0;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
    }
    .modal-close:hover { color: var(--text); }
    .modal-title { margin: 0 0 12px 0; font-size: 16px; }
    .modal-section { margin-bottom: 12px; }
    .modal-section-title { font-size: 12px; color: var(--muted); text-transform: uppercase; margin-bottom: 4px; }
    .modal-text { font-size: 14px; line-height: 1.5; }
    .tweet-card {
      background: #0e1216;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    .tweet-card-header { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .tweet-card-user { font-weight: 600; color: var(--text); }
    .tweet-card-handle { color: var(--muted); font-size: 12px; }
    .tweet-card-date { color: var(--muted); font-size: 12px; margin-left: auto; }
    .tweet-card-text { font-size: 14px; line-height: 1.5; }
    .tweet-card-meta { font-size: 11px; color: var(--muted); margin-top: 8px; }
    .clickable-story { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }
    .clickable-story:hover { color: var(--accent); }
    .analogy-card {
      background: #0e1216;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 6px;
    }
    .analogy-source { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    .analogy-target { font-size: 13px; margin-bottom: 4px; }
    .analogy-type { font-size: 11px; color: var(--accent); }
    .tab-bar { display: flex; gap: 4px; margin-bottom: 10px; }
    .tab-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--muted);
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
    }
    .tab-btn.active { background: var(--accent); color: #07130d; border-color: var(--accent); }
    .file-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .file-label { font-size: 11px; color: var(--muted); }
    @media (max-width: 1100px) {
      #layout { grid-template-columns: 1fr; grid-template-areas: "map" "sidebar" "bottom"; height: auto; }
      #map { height: 45vh; }
    }
  </style>
</head>
<body>
  <div id="err" class="error-banner" role="alert">
    <span id="err-text">Error</span>
    <button aria-label="Dismiss error" id="err-close" title="Dismiss">&times;</button>
  </div>

  <header>
    <h1>Story Reference Explorer <span class="small" id="dataset-title"></span></h1>
    <div class="controls-row" aria-label="File & URL loader">
      <div class="file-row">
        <span class="file-label">Stories JSON:</span>
        <input id="file-input" type="file" accept=".json,application/json" aria-label="Choose Stories JSON file" />
      </div>
      <div class="file-row">
        <span class="file-label">Analogies JSON:</span>
        <input id="analogy-file-input" type="file" accept=".json,application/json" aria-label="Choose Analogies JSON file" />
      </div>
      <div class="file-row">
        <span class="file-label">Source Tweets CSV:</span>
        <input id="csv-file-input" type="file" accept=".csv,text/csv" aria-label="Choose Source Tweets CSV file" />
      </div>
      <div class="input" role="group" aria-label="URL fetch">
        <input type="text" id="url-input" placeholder="https://.../data.json" aria-label="Data URL" />
        <button id="btn-fetch" class="btn" aria-label="Fetch via URL">Fetch</button>
      </div>
    </div>
    <div class="controls-row">
      <span id="meta-pill" class="pill" aria-live="polite" title="filename · tweets · spans">No dataset loaded</span>
      <span id="csv-pill" class="pill" aria-live="polite">No CSV loaded</span>
      <span id="analogy-pill" class="pill" aria-live="polite">No analogies loaded</span>
    </div>
  </header>

  <div id="layout">
    <aside id="sidebar">
      <div class="panel" style="margin:12px;">
        <h3>Map & Cluster</h3>
        <div class="row">
          <label for="clusterMiles" class="small">Cluster radius (miles)</label>
          <input type="range" id="clusterMiles" min="10" max="500" value="100" step="10" aria-valuemin="10" aria-valuemax="500" aria-label="Cluster radius miles">
          <span class="kv"><span id="clusterMilesVal">100</span> mi</span>
        </div>
        <div class="row small">
          <span>Circle size scales to √count. Click to zoom; hover for details.</span>
        </div>
        <div class="row">
          <button id="btn-export" class="btn secondary" aria-label="Export filtered events to CSV">Export CSV</button>
        </div>
      </div>

      <div class="panel" style="margin:12px;">
        <h3>Tweet date</h3>
        <div id="tweet-slider" class="slider" aria-label="Tweet date range slider"></div>
        <div class="row small">
          <span id="tweet-range-label">N/A</span>
        </div>
        <div class="row" style="margin-top:8px;">
          <label class="small" for="play-step">Step</label>
          <select id="play-step" aria-label="Play step">
            <option value="day">Day</option>
            <option value="week">Week</option>
            <option value="month">Month</option>
          </select>
          <label class="small" for="win-days">Window size (days)</label>
          <input id="win-days" type="number" value="14" min="1" step="1" aria-label="Window size in days" style="width:90px;"/>
          <button id="btn-play" class="btn" aria-pressed="false" aria-label="Play sliding window">Play</button>
        </div>
        <div class="vis-note small" id="play-note"></div>
      </div>

      <div class="panel" style="margin:12px;">
        <h3>Story year</h3>
        <div id="story-slider" class="slider" aria-label="Story year filter"></div>
        <div class="row small">
          <span id="story-range-label">N/A</span>
        </div>
        <div class="row" style="margin-top:8px;">
          <span class="small">Quick decades:</span>
          <div class="row">
            <button class="btn ghost small-btn" data-decade="1900">1900s</button>
            <button class="btn ghost small-btn" data-decade="1950">1950s</button>
            <button class="btn ghost small-btn" data-decade="2000">2000s</button>
            <button class="btn ghost small-btn" data-decade="2010">2010s</button>
            <button class="btn ghost small-btn" data-decade="2020">2020s</button>
          </div>
        </div>
      </div>

      <div class="panel" style="margin:12px;">
        <h3>Stories</h3>
        <div class="row" style="gap:6px;margin-bottom:6px;">
          <button id="story-all" class="btn ghost">All</button>
          <button id="story-none" class="btn ghost">None</button>
        </div>
        <div class="searchbox">
          <input id="story-search" type="text" placeholder="Search stories..." aria-label="Search stories">
        </div>
        <div id="story-list" class="scroll" role="listbox" aria-label="Stories list"></div>
      </div>

      <div class="panel" style="margin:12px;">
        <h3>Actors</h3>
        <div class="row" style="gap:6px;margin-bottom:6px;">
          <button id="actor-all" class="btn ghost">All</button>
          <button id="actor-none" class="btn ghost">None</button>
          <button id="actor-top25" class="btn ghost">Top 25</button>
        </div>
        <div class="searchbox">
          <input id="actor-search" type="text" placeholder="Search actors..." aria-label="Search actors">
        </div>
        <div id="actor-list" class="scroll" role="listbox" aria-label="Actors list"></div>
      </div>

      <div class="panel" style="margin:12px;" id="analogies-panel">
        <h3>Analogies</h3>
        <div class="row" style="gap:6px;margin-bottom:6px;">
          <button id="analogy-all" class="btn ghost">All</button>
          <button id="analogy-none" class="btn ghost">None</button>
        </div>
        <div class="searchbox">
          <input id="analogy-search" type="text" placeholder="Search analogies..." aria-label="Search analogies">
        </div>
        <div id="analogy-list" class="scroll" role="listbox" aria-label="Analogies list" style="max-height:220px;"></div>
        <div class="small" style="margin-top:6px;">
          <span id="analogy-count">0 analogies</span>
        </div>
      </div>
    </aside>

    <section id="map" class="panel" aria-label="Map"></section>

    <section id="bottom">
      <div class="panel">
        <h3>Top Stories</h3>
        <div class="chart-wrap"><canvas id="chart-stories" aria-label="Top stories chart"></canvas></div>
      </div>
      <div class="panel">
        <h3>Top Actors</h3>
        <div class="chart-wrap"><canvas id="chart-actors" aria-label="Top actors chart"></canvas></div>
      </div>
      <div class="panel">
        <h3>References Over Time</h3>
        <div class="chart-wrap"><canvas id="chart-time" aria-label="References over time chart"></canvas></div>
      </div>
    </section>
  </div>

  <div class="footer-bar">
    <div class="legend">
      <span>Columns in CSV export: tweet_id, author_id, tweet_location, tweet_date, story, story_year_start, story_year_end, story_location, lat, lon, ref_type, actors (normalized)</span>
    </div>
    <div class="stat">
      <span id="stat-filtered">0 events</span>
    </div>
  </div>

  <!-- Modal for viewing source tweets -->
  <div id="source-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content">
      <button class="modal-close" id="modal-close" aria-label="Close modal">&times;</button>
      <h2 class="modal-title" id="modal-title">Source Tweets</h2>
      <div class="tab-bar" id="modal-tabs">
        <button class="tab-btn active" data-tab="tweets">Source Tweets</button>
        <button class="tab-btn" data-tab="analogies">Analogies</button>
      </div>
      <div id="modal-tweets-content"></div>
      <div id="modal-analogies-content" class="hidden"></div>
    </div>
  </div>

  <!-- Dynamic loader + full app in one module -->
  <script type="module">
    // ---------- Error banner ----------
    const errEl = document.getElementById('err');
    const errText = document.getElementById('err-text');
    const errClose = document.getElementById('err-close');
    errClose.addEventListener('click', () => errEl.classList.remove('show'));
    function showError(msg) {
      errText.textContent = msg;
      errEl.classList.add('show');
    }
    function loadCSS(url) {
      return new Promise((resolve, reject) => {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = url;
        link.onload = () => resolve();
        link.onerror = () => reject(new Error('CSS failed: ' + url));
        document.head.appendChild(link);
      });
    }
    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = url;
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Script failed: ' + url));
        document.head.appendChild(s);
      });
    }
    async function loadWithFallbacks(kind, urls, check) {
      let lastErr = null;
      for (const u of urls) {
        try {
          if (u.endsWith('.css')) {
            await loadCSS(u);
          } else {
            await loadScript(u);
          }
          if (typeof check === 'function') await check();
          return true;
        } catch (e) {
          lastErr = e;
        }
      }
      showError(`Failed to load ${kind}: ${lastErr?.message || 'unknown error'}`);
      return false;
    }
    const urls = {
      leaflet_css: [
        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
        'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css',
        'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css'
      ],
      leaflet_js: [
        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
        'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js',
        'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'
      ],
      noui_css: [
        'https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css',
        'https://unpkg.com/nouislider@15.7.1/dist/nouislider.min.css',
        'https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css'
      ],
      noui_js: [
        'https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js',
        'https://unpkg.com/nouislider@15.7.1/dist/nouislider.min.js',
        'https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js'
      ],
      chart_js: [
        'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js',
        'https://unpkg.com/chart.js@4.4.1/dist/chart.umd.js',
        'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js'
      ]
    };
    const [leafletOK, leafletJSOK, nouiCSSOK, nouiJSOK, chartOK] = await Promise.all([
      loadWithFallbacks('Leaflet CSS', urls.leaflet_css),
      loadWithFallbacks('Leaflet', urls.leaflet_js, () => Promise.resolve(window.L)),
      loadWithFallbacks('noUiSlider CSS', urls.noui_css),
      loadWithFallbacks('noUiSlider', urls.noui_js, () => Promise.resolve(window.noUiSlider)),
      loadWithFallbacks('Chart.js', urls.chart_js, () => Promise.resolve(window.Chart))
    ]);

    // ---------- App code ----------
    const L_ok = typeof L !== 'undefined';
    const Chart_ok = typeof Chart !== 'undefined';
    const noUi_ok = typeof noUiSlider !== 'undefined';

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const datasetTitleEl = $('#dataset-title');
    const metaPillEl = $('#meta-pill');
    const csvPillEl = $('#csv-pill');
    const analogyPillEl = $('#analogy-pill');
    const fileInput = $('#file-input');
    const analogyFileInput = $('#analogy-file-input');
    const csvFileInput = $('#csv-file-input');
    const urlInput = $('#url-input');
    const fetchBtn = $('#btn-fetch');
    const exportBtn = $('#btn-export');

    // Analogy panel elements
    const analogyListEl = $('#analogy-list');
    const analogySearch = $('#analogy-search');
    const analogyAllBtn = $('#analogy-all');
    const analogyNoneBtn = $('#analogy-none');
    const analogyCountEl = $('#analogy-count');

    // Modal elements
    const sourceModal = $('#source-modal');
    const modalClose = $('#modal-close');
    const modalTitle = $('#modal-title');
    const modalTabs = $('#modal-tabs');
    const modalTweetsContent = $('#modal-tweets-content');
    const modalAnalogiesContent = $('#modal-analogies-content');

    const clusterMilesInput = $('#clusterMiles');
    const clusterMilesVal = $('#clusterMilesVal');
    clusterMilesVal.textContent = clusterMilesInput.value;

    const tweetSliderEl = $('#tweet-slider');
    const storySliderEl = $('#story-slider');
    const tweetRangeLabel = $('#tweet-range-label');
    const storyRangeLabel = $('#story-range-label');
    const playStepSel = $('#play-step');
    const winDaysInput = $('#win-days');
    const playBtn = $('#btn-play');
    const playNote = $('#play-note');

    const storyListEl = $('#story-list');
    const storySearch = $('#story-search');
    const storyAllBtn = $('#story-all');
    const storyNoneBtn = $('#story-none');

    const actorListEl = $('#actor-list');
    const actorSearch = $('#actor-search');
    const actorAllBtn = $('#actor-all');
    const actorNoneBtn = $('#actor-none');
    const actorTop25Btn = $('#actor-top25');

    const statFilteredEl = $('#stat-filtered');
    const decadeBtns = $$('.small-btn[data-decade]');

    let map, markersLayer;
    let chartStories, chartActors, chartTime;

    // Data and state
    let tweets = [];
    let events = [];
    let filenameLabel = '';
    let storyYearMin = null, storyYearMax = null;
    let tweetDateMin = null, tweetDateMax = null;
    let storyCountsGlobal = new Map();
    let actorCountsGlobal = new Map();

    // CSV source tweets data (indexed by tweet_id)
    let sourceTweetsMap = new Map();
    let csvLoaded = false;

    // Analogies data
    let analogiesData = new Map(); // tweet_id -> { text_cleaned, analogies: [...] }
    let analogyItems = []; // Flattened list of all analogies for display
    let analogyCountsGlobal = new Map(); // source/target -> count
    let selectedAnalogies = new Set();
    let analogiesMode = 'all';
    let analogiesLoaded = false;

    // Selection modes: 'all' | 'some' | 'none'
    let storiesMode = 'all';
    let actorsMode = 'all';
    let selectedStories = new Set();
    let selectedActors = new Set();
    let haveTweetDates = false;

    function fmt(n) { return n.toLocaleString(); }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function parseJSONMaybe(text) {
      try { return JSON.parse(text); } catch (e) { return null; }
    }
    function toArrayInput(json) {
      if (Array.isArray(json)) return json;
      if (json && typeof json === 'object') {
        return Object.entries(json).map(([k, v]) => ({ tweet_id: k, ...v }));
      }
      return [];
    }
    function toDateLocalYYYYMMDD(s) {
      if (!s || typeof s !== 'string') return null;
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) {
        const [_, y, mo, d] = m;
        const dt = new Date(Number(y), Number(mo)-1, Number(d));
        return isNaN(dt.getTime()) ? null : dt;
      }
      const dt = new Date(s);
      return isNaN(dt.getTime()) ? null : dt;
    }
    const CURRENT_YEAR = new Date().getFullYear();
    function parseYearNumber(val) {
      if (val == null) return null;
      if (typeof val === 'number') return val;
      let s = String(val).trim().toLowerCase();
      if (!s) return null;
      if (s.includes('present') || s.includes('now')) return CURRENT_YEAR;
      s = s.replace(/[cC]\.\s*/g, '');
      s = s.replace(/\b(ce|ad)\b\.?/g, '');
      s = s.replace(/[^0-9\-–—]/g, '');
      const m = s.match(/^-?0*(\d{1,6})$/);
      if (m) return Number(m[1]);
      const n = parseInt(s, 10);
      return isNaN(n) ? null : n;
    }
    function parseYearRangeFromLabel(label) {
      if (!label || typeof label !== 'string') return [null, null];
      let s = label.trim().replace(/[–—]/g, '-').replace(/[cC]\.\s*/g, '').replace(/\b(CE|AD)\b\.?/gi,'');
      const lower = s.toLowerCase();
      if (lower.includes('present') || lower.includes('now')) {
        const m = s.match(/(\d{1,6})/);
        const start = m ? parseInt(m[1],10) : CURRENT_YEAR;
        return [start, CURRENT_YEAR];
      }
      const rm = s.match(/(\d{1,6})\s*-\s*(\d{1,6})/);
      if (rm) return [parseInt(rm[1],10), parseInt(rm[2],10)];
      const sm = s.match(/(\d{1,6})/);
      if (sm) { const y = parseInt(sm[1],10); return [y,y]; }
      return [null, null];
    }

    // CSV parsing function
    function parseCSV(text) {
      const lines = text.split(/\r?\n/);
      if (lines.length < 2) return [];
      const headerLine = lines[0];
      const headers = parseCSVLine(headerLine);
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const values = parseCSVLine(line);
        const row = {};
        for (let j = 0; j < headers.length; j++) {
          row[headers[j]] = values[j] || '';
        }
        rows.push(row);
      }
      return rows;
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (inQuotes) {
          if (c === '"') {
            if (line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = false;
            }
          } else {
            current += c;
          }
        } else {
          if (c === '"') {
            inQuotes = true;
          } else if (c === ',') {
            result.push(current);
            current = '';
          } else {
            current += c;
          }
        }
      }
      result.push(current);
      return result;
    }

    // Load CSV data into sourceTweetsMap
    function loadCSVData(rows) {
      sourceTweetsMap.clear();
      for (const row of rows) {
        const tweetId = row.tweet_id;
        if (!tweetId) continue;
        sourceTweetsMap.set(String(tweetId), {
          internal_id: row.internal_id || '',
          author_id: row.author_id || '',
          tweet_id: tweetId,
          text_original: row.text_original || '',
          text_cleaned: row.text_cleaned || '',
          topic_label: row.Topic_label_merged || '',
          language: row.language || '',
          created_at_local: row.created_at_local || '',
          created_at_date_local: row.created_at_date_local || '',
          user_name: row.user_name || '',
          screen_name: row.screen_name || '',
          user_description: row.user_description || '',
          tweet_location: row.tweet_location || ''
        });
      }
      csvLoaded = true;
      csvPillEl.textContent = `CSV: ${fmt(sourceTweetsMap.size)} tweets`;
    }

    // Load analogies data
    function loadAnalogiesData(json) {
      analogiesData.clear();
      analogyItems = [];
      analogyCountsGlobal.clear();

      const entries = Array.isArray(json) ? json : Object.values(json);
      for (const entry of entries) {
        const tweetId = String(entry.tweet_id || '');
        if (!tweetId) continue;
        const textCleaned = entry.text_cleaned || '';
        const analogies = Array.isArray(entry.analogies) ? entry.analogies : [];

        analogiesData.set(tweetId, { text_cleaned: textCleaned, analogies });

        // Create flattened analogy items for display
        for (const analogy of analogies) {
          const source = analogy.source || analogy.source_entity || '';
          const target = analogy.target || analogy.target_entity || '';
          const type = analogy.type || analogy.analogy_type || '';
          const explanation = analogy.explanation || analogy.reasoning || '';

          if (source || target) {
            analogyItems.push({
              tweetId,
              textCleaned,
              source,
              target,
              type,
              explanation
            });

            // Count for filtering
            const key = `${source} → ${target}`;
            analogyCountsGlobal.set(key, (analogyCountsGlobal.get(key) || 0) + 1);
          }
        }
      }

      analogiesLoaded = true;
      analogyPillEl.textContent = `Analogies: ${fmt(analogyItems.length)}`;
      analogyCountEl.textContent = `${fmt(analogyItems.length)} analogies`;
      initAnalogyList();
    }

    // Get source tweet by ID
    function getSourceTweet(tweetId) {
      return sourceTweetsMap.get(String(tweetId));
    }

    // Get analogies for a tweet ID
    function getAnalogiesForTweet(tweetId) {
      const data = analogiesData.get(String(tweetId));
      return data ? data.analogies : [];
    }

    // Get all tweets that mention a story
    function getTweetsForStory(storyName) {
      const tweetIds = new Set();
      for (const ev of events) {
        if (ev.storyName === storyName) {
          tweetIds.add(ev.tweetId);
        }
      }
      return Array.from(tweetIds);
    }

    function normalizeTweets(raw) {
      const arr = toArrayInput(raw);
      const norm = [];
      for (const t of arr) {
        const tweetId = t.tweet_id != null ? String(t.tweet_id) : '';
        const authorId = t.author_id != null ? String(t.author_id) : '';
        const tweetLoc = t.tweet_location || '';
        const tweetDate = toDateLocalYYYYMMDD(t.created_at_date_local);
        const spans = Array.isArray(t.spans) ? t.spans : [];
        norm.push({ tweetId, authorId, tweetLoc, tweetDate, spans });
      }
      return norm;
    }
    function normalizeEvents(tweets) {
      const out = [];
      storyCountsGlobal.clear();
      actorCountsGlobal.clear();
      let minYear = Infinity, maxYear = -Infinity;
      let minDate = new Date(8640000000000000), maxDate = new Date(-8640000000000000);
      let haveDates = false;
      for (const t of tweets) {
        if (t.tweetDate instanceof Date && !isNaN(t.tweetDate)) {
          haveDates = true;
          if (t.tweetDate < minDate) minDate = t.tweetDate;
          if (t.tweetDate > maxDate) maxDate = t.tweetDate;
        }
        for (const s of t.spans) {
          const storyName = (s.storyName || '').trim();
          if (!storyName) continue;
          const lat = typeof s.storyLocationLat === 'number' ? s.storyLocationLat : null;
          const lon = typeof s.storyLocationLon === 'number' ? s.storyLocationLon : null;
          if (lat == null || lon == null || isNaN(lat) || isNaN(lon)) continue;

          let yStart = parseYearNumber(s.storyYearStart);
          let yEnd   = parseYearNumber(s.storyYearEnd);
          if (yStart == null || yEnd == null) {
            const [a,b] = parseYearRangeFromLabel(s.storyYear || '');
            if (yStart == null) yStart = a;
            if (yEnd == null) yEnd = b;
          }
          if (yStart != null && yEnd != null) {
            if (yStart > yEnd) [yStart, yEnd] = [yEnd, yStart];
            minYear = Math.min(minYear, yStart);
            maxYear = Math.max(maxYear, yEnd);
          }
          // Use normalized actors if available; skip non-normalized actors for better clustering
          const actors = Array.isArray(s.actors_normalized) && s.actors_normalized.length > 0
            ? s.actors_normalized.filter(Boolean).map(String)
            : [];
          const spanText = s.span || '';
          const storyLocation = s.storyLocation || '';
          const refType = s.ref_type || '';
          const abstract = s.abstract || '';
          const storyYearLabel = s.storyYear || '';

          storyCountsGlobal.set(storyName, (storyCountsGlobal.get(storyName)||0)+1);
          for (const a of actors) actorCountsGlobal.set(a, (actorCountsGlobal.get(a)||0)+1);

          out.push({
            tweetId: t.tweetId,
            authorId: t.authorId,
            tweetLoc: t.tweetLoc,
            tweetDate: t.tweetDate instanceof Date && !isNaN(t.tweetDate) ? t.tweetDate : null,
            spanText,
            storyName,
            storyYearStart: yStart,
            storyYearEnd: yEnd,
            storyYearLabel,
            lat, lon,
            storyLocation,
            refType,
            abstract,
            actors
          });
        }
      }
      storyYearMin = (minYear === Infinity) ? null : minYear;
      storyYearMax = (maxYear === -Infinity) ? null : maxYear;
      tweetDateMin = haveDates ? minDate : null;
      tweetDateMax = haveDates ? maxDate : null;
      haveTweetDates = haveDates;
      return out;
    }

    function intervalsOverlap(a1,a2,b1,b2) {
      if (a1 == null || a2 == null || b1 == null || b2 == null) return true;
      return Math.max(a1,b1) <= Math.min(a2,b2);
    }

    function eventPassesFilters(ev, tf, yf) {
      if (tf && ev.tweetDate) {
        if (ev.tweetDate < tf.start || ev.tweetDate > tf.end) return false;
      }
      if (yf && (ev.storyYearStart != null && ev.storyYearEnd != null)) {
        if (!intervalsOverlap(ev.storyYearStart, ev.storyYearEnd, yf.y1, yf.y2)) return false;
      }
      // Stories
      if (storiesMode === 'none') return false;
      if (storiesMode === 'some' && !selectedStories.has(ev.storyName)) return false;
      // Actors
      if (actorsMode === 'none') return false;
      if (actorsMode === 'some') {
        let hit = false;
        for (const a of ev.actors) if (selectedActors.has(a)) { hit = true; break; }
        if (!hit) return false;
      }
      return true;
    }

    function haversineMiles(lat1, lon1, lat2, lon2) {
      const R = 3958.8;
      const toRad = (d) => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function clusterEvents(evts, radiusMiles) {
      if (!evts.length) return [];
      const latStep = radiusMiles / 69;
      const lonStep = radiusMiles / 69;
      const grid = new Map();
      function cellKey(lat, lon) {
        const i = Math.floor(lat / latStep);
        const j = Math.floor(lon / lonStep);
        return i + ':' + j;
      }
      const clusters = [];
      const cellToClusterIdx = new Map();
      for (const ev of evts) {
        const key = cellKey(ev.lat, ev.lon);
        let candidateIdxs = [];
        const [ci, cj] = key.split(':').map(Number);
        for (let di=-1; di<=1; di++) for (let dj=-1; dj<=1; dj++) {
          const k = (ci+di)+':' + (cj+dj);
          const idx = cellToClusterIdx.get(k);
          if (idx != null) candidateIdxs.push(idx);
        }
        let nearestIdx = -1;
        let nearestDist = Infinity;
        for (const ci2 of candidateIdxs) {
          const c = clusters[ci2];
          const d = haversineMiles(ev.lat, ev.lon, c.lat, c.lon);
          if (d <= radiusMiles && d < nearestDist) { nearestDist = d; nearestIdx = ci2; }
        }
        if (nearestIdx >= 0) {
          const c = clusters[nearestIdx];
          const n1 = c.n;
          c.lat = (c.lat*n1 + ev.lat) / (n1+1);
          c.lon = (c.lon*n1 + ev.lon) / (n1+1);
          c.n += 1;
          c.items.push(ev);
          c.storyCounts.set(ev.storyName, (c.storyCounts.get(ev.storyName)||0)+1);
          for (const a of ev.actors) c.actorCounts.set(a, (c.actorCounts.get(a)||0)+1);
        } else {
          const idx = clusters.length;
          const cl = { lat: ev.lat, lon: ev.lon, n: 1, items: [ev], storyCounts: new Map(), actorCounts: new Map() };
          cl.storyCounts.set(ev.storyName, 1);
          for (const a of ev.actors) cl.actorCounts.set(a, (cl.actorCounts.get(a)||0)+1);
          clusters.push(cl);
          cellToClusterIdx.set(key, idx);
        }
      }
      return clusters;
    }

    function ensureMap() {
      if (!L_ok) { showError('Leaflet failed to load; map features disabled.'); return; }
      if (!map) {
        map = L.map('map', { zoomControl: true }).setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19, attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        markersLayer = L.layerGroup().addTo(map);
      }
    }
    function updateMap(filtered) {
      if (!L_ok) return;
      ensureMap();
      markersLayer.clearLayers();
      if (!filtered.length) return;
      const radiusMiles = Number(clusterMilesInput.value);
      const clusters = clusterEvents(filtered, radiusMiles);
      const latlngs = clusters.map(c => [c.lat, c.lon]);
      if (latlngs.length) {
        try {
          const b = L.latLngBounds(latlngs);
          if (b.isValid()) map.fitBounds(b.pad(0.2), { animate: false });
        } catch {}
      }
      const maxN = Math.max(...clusters.map(c => c.n));
      const minR = 6, maxR = 36;
      const k = maxN > 0 ? (maxR - minR) / (Math.sqrt(maxN) - 1 || 1) : 1;

      clusters.forEach(c => {
        const r = Math.round(minR + k * (Math.sqrt(c.n) - 1));
        const circle = L.circleMarker([c.lat, c.lon], {
          radius: r, color: '#6dd39e', weight: 1, fillColor: '#3aa675', fillOpacity: 0.4
        });
        const topStories = [...c.storyCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([s,n])=>`${s} (${n})`).join('<br>');
        const topActors = [...c.actorCounts.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([s,n])=>`${s} (${n})`).join('<br>');
        circle.bindPopup(`
          <div><strong>Cluster center</strong>: ${c.lat.toFixed(4)}, ${c.lon.toFixed(4)}</div>
          <div><strong>Total references</strong>: ${c.n}</div>
          <div style="margin-top:6px;"><strong>Top stories</strong><br>${topStories || '—'}</div>
          <div style="margin-top:6px;"><strong>Top actors</strong><br>${topActors || '—'}</div>
        `);
        circle.on('click', () => map.setView([c.lat, c.lon], Math.min(map.getZoom()+2, 12)));
        circle.addTo(markersLayer);
      });
    }

    function ensureCharts() {
      if (!Chart_ok) { showError('Chart.js failed to load; charts disabled.'); return; }
      const storiesCtx = document.getElementById('chart-stories');
      const actorsCtx = document.getElementById('chart-actors');
      const timeCtx = document.getElementById('chart-time');
      chartStories = new Chart(storiesCtx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'References', data: [] }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#cfd7df' }}, y: { ticks: { color: '#cfd7df' }}}, plugins: { legend: { labels: { color: '#cfd7df' }}}}
      });
      chartActors = new Chart(actorsCtx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: 'References', data: [] }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#cfd7df' }}, y: { ticks: { color: '#cfd7df' }}}, plugins: { legend: { labels: { color: '#cfd7df' }}}}
      });
      chartTime = new Chart(timeCtx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Refs per day', data: [], fill: false, tension: 0.1 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: '#cfd7df' }}, y: { ticks: { color: '#cfd7df' }}}, plugins: { legend: { labels: { color: '#cfd7df' }}}}
      });
    }

    function updateCharts(filtered) {
      if (!Chart_ok || !chartStories) return;
      const sCount = new Map();
      const aCount = new Map();
      for (const ev of filtered) {
        sCount.set(ev.storyName, (sCount.get(ev.storyName)||0)+1);
        for (const a of ev.actors) aCount.set(a, (aCount.get(a)||0)+1);
      }
      const sTop = [...sCount.entries()].sort((a,b)=>b[1]-a[1]).slice(0,20);
      const aTop = [...aCount.entries()].sort((a,b)=>b[1]-a[1]).slice(0,20);
      chartStories.data.labels = sTop.map(x=>x[0]);
      chartStories.data.datasets[0].data = sTop.map(x=>x[1]);
      chartStories.update();
      chartActors.data.labels = aTop.map(x=>x[0]);
      chartActors.data.datasets[0].data = aTop.map(x=>x[1]);
      chartActors.update();

      const byDay = new Map();
      for (const ev of filtered) {
        if (!ev.tweetDate) continue;
        const d = new Date(ev.tweetDate.getFullYear(), ev.tweetDate.getMonth(), ev.tweetDate.getDate());
        const k = d.toISOString().slice(0,10);
        byDay.set(k, (byDay.get(k)||0)+1);
      }
      const labels = [...byDay.keys()].sort();
      chartTime.data.labels = labels;
      chartTime.data.datasets[0].data = labels.map(k => byDay.get(k));
      chartTime.update();
    }

    function initTweetSlider() {
      if (!noUi_ok) { showError('noUiSlider failed to load; sliders disabled.'); return; }
      tweetSliderEl.innerHTML = '';
      if (!haveTweetDates || !tweetDateMin || !tweetDateMax) {
        tweetSliderEl.classList.add('hidden');
        tweetRangeLabel.textContent = 'No tweet dates in dataset';
        playBtn.disabled = true;
        playNote.textContent = 'Play disabled: dataset lacks valid tweet dates.';
        return;
      }
      tweetSliderEl.classList.remove('hidden');
      playBtn.disabled = false;
      playNote.textContent = '';
      const minTS = tweetDateMin.getTime();
      const maxTS = tweetDateMax.getTime();
      noUiSlider.create(tweetSliderEl, {
        start: [minTS, maxTS],
        connect: true,
        range: { min: minTS, max: maxTS },
        step: 24*3600*1000,
        tooltips: [true, true],
        format: { to: v => Math.round(v), from: v => Number(v) },
        behaviour: 'drag'
      });
      tweetSliderEl.noUiSlider.on('update', () => {
        const [a,b] = tweetSliderEl.noUiSlider.get().map(Number);
        const d1 = new Date(a), d2 = new Date(b);
        tweetRangeLabel.textContent = d1.toISOString().slice(0,10) + ' to ' + d2.toISOString().slice(0,10);
      });
      tweetSliderEl.noUiSlider.on('change', triggerUpdate);
    }

    function initStorySlider() {
      if (!noUi_ok) return;
      storySliderEl.innerHTML = '';
      const y1 = storyYearMin ?? 0;
      const y2 = storyYearMax ?? CURRENT_YEAR;
      noUiSlider.create(storySliderEl, {
        start: [y1, y2],
        connect: true,
        range: { min: y1, max: y2 },
        step: 1,
        tooltips: [true, true],
        format: { to: v => Math.round(v), from: v => Number(v) },
        behaviour: 'drag'
      });
      const setLabel = () => {
        const [a,b] = storySliderEl.noUiSlider.get().map(v=>Math.round(Number(v)));
        storyRangeLabel.textContent = `${a} to ${b}`;
      };
      storySliderEl.noUiSlider.on('update', setLabel);
      storySliderEl.noUiSlider.on('change', triggerUpdate);
      setLabel();
    }

    function applyDecade(decStart) {
      if (!noUi_ok || !storySliderEl.noUiSlider) return;
      const a = Number(decStart), b = a + 9;
      storySliderEl.noUiSlider.set([a, b]);
      triggerUpdate();
    }

    function makeCheckboxList(container, items, mode, selectedSet, isStoryList = false) {
      container.innerHTML = '';
      for (const name of items) {
        const id = container.id + '_' + name.replace(/\W+/g,'_');
        const div = document.createElement('div');
        div.className = 'list-item';
        const checked = mode === 'all' ? 'checked' : (mode === 'some' && selectedSet.has(name) ? 'checked' : '');
        if (isStoryList) {
          div.innerHTML = `
            <label class="checkbox" for="${id}">
              <input id="${id}" type="checkbox" ${checked} data-name="${name}" />
              <span class="clickable-story" data-story="${escapeHtml(name)}">${name}</span>
            </label>`;
        } else {
          div.innerHTML = `
            <label class="checkbox" for="${id}">
              <input id="${id}" type="checkbox" ${checked} data-name="${name}" />
              <span>${name}</span>
            </label>`;
        }
        container.appendChild(div);
      }

      // Add click handler for story names
      if (isStoryList) {
        container.addEventListener('click', (e) => {
          const storySpan = e.target.closest('.clickable-story');
          if (storySpan) {
            e.preventDefault();
            e.stopPropagation();
            handleStoryClick(storySpan.dataset.story);
          }
        });
      }
    }
    function getAllItemNames(container) {
      return Array.from(container.querySelectorAll('input[type="checkbox"]')).map(cb => cb.dataset.name);
    }
    function filterList(container, query) {
      const q = (query||'').trim().toLowerCase();
      for (const div of container.children) {
        const name = div.querySelector('input').dataset.name.toLowerCase();
        div.style.display = !q || name.includes(q) ? '' : 'none';
      }
    }
    function collectSelected(container) {
      const cbs = container.querySelectorAll('input[type="checkbox"]');
      const sel = new Set();
      for (const cb of cbs) if (cb.checked) sel.add(cb.dataset.name);
      return sel;
    }

    function initLists() {
      const stories = [...storyCountsGlobal.keys()].sort((a,b)=>a.localeCompare(b));
      makeCheckboxList(storyListEl, stories, storiesMode, selectedStories, true); // true = clickable stories
      storyListEl.onchange = () => {
        selectedStories = collectSelected(storyListEl);
        const allNames = getAllItemNames(storyListEl);
        if (selectedStories.size === 0) storiesMode = 'none';
        else if (selectedStories.size === allNames.length) storiesMode = 'all';
        else storiesMode = 'some';
        triggerUpdate();
      };
      storyAllBtn.onclick = () => {
        storiesMode = 'all'; selectedStories.clear();
        for (const cb of storyListEl.querySelectorAll('input')) cb.checked = true;
        triggerUpdate();
      };
      storyNoneBtn.onclick = () => {
        storiesMode = 'none'; selectedStories.clear();
        for (const cb of storyListEl.querySelectorAll('input')) cb.checked = false;
        triggerUpdate();
      };
      storySearch.oninput = () => filterList(storyListEl, storySearch.value);

      const actors = [...actorCountsGlobal.keys()].sort((a,b)=>a.localeCompare(b));
      makeCheckboxList(actorListEl, actors, actorsMode, selectedActors);
      actorListEl.onchange = () => {
        selectedActors = collectSelected(actorListEl);
        const allNames = getAllItemNames(actorListEl);
        if (selectedActors.size === 0) actorsMode = 'none';
        else if (selectedActors.size === allNames.length) actorsMode = 'all';
        else actorsMode = 'some';
        triggerUpdate();
      };
      actorAllBtn.onclick = () => {
        actorsMode = 'all'; selectedActors.clear();
        for (const cb of actorListEl.querySelectorAll('input')) cb.checked = true;
        triggerUpdate();
      };
      actorNoneBtn.onclick = () => {
        actorsMode = 'none'; selectedActors.clear();
        for (const cb of actorListEl.querySelectorAll('input')) cb.checked = false;
        triggerUpdate();
      };
      actorTop25Btn.onclick = () => {
        const top25 = [...actorCountsGlobal.entries()].sort((a,b)=>b[1]-a[1]).slice(0,25).map(x=>x[0]);
        actorsMode = 'some'; selectedActors = new Set(top25);
        for (const cb of actorListEl.querySelectorAll('input')) cb.checked = top25.includes(cb.dataset.name);
        triggerUpdate();
      };
      actorSearch.oninput = () => filterList(actorListEl, actorSearch.value);
    }

    function initAnalogyList() {
      if (!analogyItems.length) {
        analogyListEl.innerHTML = '<div class="small">No analogies loaded</div>';
        return;
      }

      // Get unique analogy keys for the checkbox list
      const uniqueKeys = [...analogyCountsGlobal.keys()].sort((a, b) => a.localeCompare(b));
      makeCheckboxList(analogyListEl, uniqueKeys, analogiesMode, selectedAnalogies);

      analogyListEl.onchange = () => {
        selectedAnalogies = collectSelected(analogyListEl);
        const allNames = getAllItemNames(analogyListEl);
        if (selectedAnalogies.size === 0) analogiesMode = 'none';
        else if (selectedAnalogies.size === allNames.length) analogiesMode = 'all';
        else analogiesMode = 'some';
      };

      analogyAllBtn.onclick = () => {
        analogiesMode = 'all';
        selectedAnalogies.clear();
        for (const cb of analogyListEl.querySelectorAll('input')) cb.checked = true;
      };

      analogyNoneBtn.onclick = () => {
        analogiesMode = 'none';
        selectedAnalogies.clear();
        for (const cb of analogyListEl.querySelectorAll('input')) cb.checked = false;
      };

      analogySearch.oninput = () => filterList(analogyListEl, analogySearch.value);
    }

    // Modal functions
    function openModal(title, tweetIds) {
      modalTitle.textContent = title;
      renderModalTweets(tweetIds);
      renderModalAnalogies(tweetIds);
      sourceModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      sourceModal.classList.remove('show');
      document.body.style.overflow = '';
    }

    function renderModalTweets(tweetIds) {
      if (!tweetIds.length) {
        modalTweetsContent.innerHTML = '<div class="small">No tweets found</div>';
        return;
      }

      let html = '';
      for (const tweetId of tweetIds) {
        const tweet = getSourceTweet(tweetId);
        if (tweet) {
          html += `
            <div class="tweet-card">
              <div class="tweet-card-header">
                <span class="tweet-card-user">${escapeHtml(tweet.user_name || 'Unknown')}</span>
                <span class="tweet-card-handle">@${escapeHtml(tweet.screen_name || '')}</span>
                <span class="tweet-card-date">${escapeHtml(tweet.created_at_date_local || '')}</span>
              </div>
              <div class="tweet-card-text">${escapeHtml(tweet.text_original || tweet.text_cleaned || '')}</div>
              <div class="tweet-card-meta">
                <span>Location: ${escapeHtml(tweet.tweet_location || 'N/A')}</span> |
                <span>Topic: ${escapeHtml(tweet.topic_label || 'N/A')}</span> |
                <span>ID: ${escapeHtml(tweet.tweet_id)}</span>
              </div>
            </div>
          `;
        } else {
          // Tweet not in CSV, try analogies data, then fall back to events
          const analogyData = analogiesData.get(String(tweetId));
          const ev = events.find(e => e.tweetId === tweetId);
          const textFromAnalogy = analogyData?.text_cleaned || '';
          const textFromEvent = ev?.spanText || '';
          const displayText = textFromAnalogy || textFromEvent || 'Source tweet text not available (CSV not loaded)';

          html += `
            <div class="tweet-card">
              <div class="tweet-card-header">
                <span class="tweet-card-user">Tweet ID: ${escapeHtml(tweetId)}</span>
                <span class="tweet-card-date">${ev?.tweetDate ? ev.tweetDate.toISOString().slice(0, 10) : ''}</span>
              </div>
              <div class="tweet-card-text">${escapeHtml(displayText)}</div>
              <div class="tweet-card-meta">
                <span>Location: ${escapeHtml(ev?.tweetLoc || 'N/A')}</span>
                ${textFromAnalogy ? ' | <span>Source: Analogies file</span>' : ''}
              </div>
            </div>
          `;
        }
      }
      modalTweetsContent.innerHTML = html || '<div class="small">No source tweets available</div>';
    }

    function renderModalAnalogies(tweetIds) {
      let html = '';
      let count = 0;

      for (const tweetId of tweetIds) {
        const data = analogiesData.get(String(tweetId));
        if (data && data.analogies.length > 0) {
          for (const analogy of data.analogies) {
            const source = analogy.source || analogy.source_entity || '';
            const target = analogy.target || analogy.target_entity || '';
            const type = analogy.type || analogy.analogy_type || '';
            const explanation = analogy.explanation || analogy.reasoning || '';

            html += `
              <div class="analogy-card">
                <div class="analogy-source">Tweet: "${escapeHtml(data.text_cleaned.slice(0, 100))}${data.text_cleaned.length > 100 ? '...' : ''}"</div>
                <div class="analogy-target"><strong>${escapeHtml(source)}</strong> → <strong>${escapeHtml(target)}</strong></div>
                ${type ? `<div class="analogy-type">Type: ${escapeHtml(type)}</div>` : ''}
                ${explanation ? `<div class="small" style="margin-top:4px;">${escapeHtml(explanation)}</div>` : ''}
              </div>
            `;
            count++;
          }
        }
      }

      if (!count) {
        modalAnalogiesContent.innerHTML = '<div class="small">No analogies found for these tweets</div>';
      } else {
        modalAnalogiesContent.innerHTML = `<div class="small" style="margin-bottom:8px;">${count} analogy/analogies found</div>` + html;
      }
    }

    // Setup modal event listeners
    function setupModalListeners() {
      modalClose.onclick = closeModal;
      sourceModal.onclick = (e) => {
        if (e.target === sourceModal) closeModal();
      };
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && sourceModal.classList.contains('show')) {
          closeModal();
        }
      });

      // Tab switching
      modalTabs.onclick = (e) => {
        const btn = e.target.closest('.tab-btn');
        if (!btn) return;
        const tab = btn.dataset.tab;
        for (const b of modalTabs.querySelectorAll('.tab-btn')) {
          b.classList.toggle('active', b === btn);
        }
        modalTweetsContent.classList.toggle('hidden', tab !== 'tweets');
        modalAnalogiesContent.classList.toggle('hidden', tab !== 'analogies');
      };
    }

    // Handle story click to show source tweets
    function handleStoryClick(storyName) {
      const tweetIds = getTweetsForStory(storyName);
      openModal(`Source Tweets: ${storyName}`, tweetIds);
    }

    function exportCSV(filtered) {
      const rows = [['tweet_id','author_id','tweet_location','tweet_date','story','story_year_start','story_year_end','story_location','lat','lon','ref_type','actors_normalized']];
      for (const ev of filtered) {
        const td = ev.tweetDate ? ev.tweetDate.toISOString().slice(0,10) : '';
        rows.push([ev.tweetId, ev.authorId, ev.tweetLoc, td, ev.storyName, ev.storyYearStart ?? '', ev.storyYearEnd ?? '', ev.storyLocation, ev.lat, ev.lon, ev.refType, ev.actors.join('|')]);
      }
      const csv = rows.map(r => r.map(x => {
        const s = (x==null ? '' : String(x));
        return s.includes(',') || s.includes('"') ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'story-reference-explorer.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    let updatePending = false;
    function triggerUpdate() {
      if (updatePending) return;
      updatePending = true;
      requestAnimationFrame(() => {
        updatePending = false;
        const tf = buildTweetDateFilter();
        const yf = buildStoryYearFilter();
        const filtered = events.filter(ev => eventPassesFilters(ev, tf, yf));
        statFilteredEl.textContent = fmt(filtered.length) + ' events';
        updateMap(filtered);
        updateCharts(filtered);
      });
    }
    let playTimer = null;
    function stepMillis(kind) {
      if (kind === 'week') return 7*24*3600*1000;
      if (kind === 'month') return 30*24*3600*1000;
      return 24*3600*1000;
    }
    function buildTweetDateFilter() {
      if (!haveTweetDates || !noUi_ok || !tweetSliderEl.noUiSlider) return null;
      const [minTS, maxTS] = tweetSliderEl.noUiSlider.get().map(v => Number(v));
      return { start: new Date(minTS), end: new Date(maxTS) };
    }
    function buildStoryYearFilter() {
      if (!noUi_ok || !storySliderEl.noUiSlider) return null;
      const [y1, y2] = storySliderEl.noUiSlider.get().map(v => Math.round(Number(v)));
      return { y1, y2 };
    }
    function startPlay() {
      if (!haveTweetDates || !noUi_ok || !tweetSliderEl.noUiSlider) return;
      const winDays = Math.max(1, Number(winDaysInput.value)||1);
      const step = stepMillis(playStepSel.value);
      const minTS = tweetDateMin.getTime();
      const maxTS = tweetDateMax.getTime();
      let curStart = minTS;
      const winMS = winDays * 24*3600*1000;
      playBtn.textContent = 'Pause';
      playBtn.setAttribute('aria-pressed','true');
      playTimer = setInterval(() => {
        const a = curStart;
        const b = Math.min(a + winMS, maxTS);
        tweetSliderEl.noUiSlider.set([a, b]);
        triggerUpdate();
        if (b >= maxTS) stopPlay();
        curStart = Math.min(curStart + step, maxTS - winMS);
      }, 400);
    }
    function stopPlay() {
      if (playTimer) clearInterval(playTimer);
      playTimer = null;
      playBtn.textContent = 'Play';
      playBtn.setAttribute('aria-pressed','false');
    }

    async function loadFromFile(file) {
      const text = await file.text();
      const json = parseJSONMaybe(text);
      if (!json) { showError('Invalid JSON file.'); return; }
      applyData(json, file.name);
    }
    async function loadFromURL(url) {
      try {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(resp.status + ' ' + resp.statusText);
        const json = await resp.json();
        applyData(json, url.split('/').pop() || 'remote.json');
      } catch (e) {
        showError('Failed to fetch ?data URL. CORS or network blocked. Keep the uploader as fallback.');
      }
    }
    function applyData(json, name='dataset.json') {
      tweets = normalizeTweets(json);
      events = normalizeEvents(tweets);
      filenameLabel = name || 'dataset.json';
      const spanCount = events.length;
      const tweetCount = tweets.length;
      metaPillEl.textContent = `${filenameLabel} · tweets ${fmt(tweetCount)} · spans ${fmt(spanCount)}`;
      datasetTitleEl.textContent = '';
      initTweetSlider();
      initStorySlider();
      ensureMap();
      if (!chartStories) ensureCharts();
      initLists();
      triggerUpdate();
    }

    clusterMilesInput.addEventListener('input', () => { clusterMilesVal.textContent = clusterMilesInput.value; });
    clusterMilesInput.addEventListener('change', triggerUpdate);
    exportBtn.addEventListener('click', () => {
      const tf = buildTweetDateFilter();
      const yf = buildStoryYearFilter();
      const filtered = events.filter(ev => eventPassesFilters(ev, tf, yf));
      exportCSV(filtered);
    });
    playBtn.addEventListener('click', () => { if (playTimer) stopPlay(); else startPlay(); });
    decadeBtns.forEach(btn => btn.addEventListener('click', () => applyDecade(btn.dataset.decade)));
    fileInput.addEventListener('change', () => { const f = fileInput.files && fileInput.files[0]; if (f) loadFromFile(f); });
    fetchBtn.addEventListener('click', () => { const url = urlInput.value.trim(); if (url) loadFromURL(url); });

    // CSV file input listener
    csvFileInput.addEventListener('change', async () => {
      const f = csvFileInput.files && csvFileInput.files[0];
      if (f) {
        try {
          const text = await f.text();
          const rows = parseCSV(text);
          loadCSVData(rows);
        } catch (e) {
          showError('Failed to parse CSV file: ' + e.message);
        }
      }
    });

    // Analogies file input listener
    analogyFileInput.addEventListener('change', async () => {
      const f = analogyFileInput.files && analogyFileInput.files[0];
      if (f) {
        try {
          const text = await f.text();
          const json = parseJSONMaybe(text);
          if (!json) {
            showError('Invalid JSON in analogies file');
            return;
          }
          loadAnalogiesData(json);
        } catch (e) {
          showError('Failed to parse analogies file: ' + e.message);
        }
      }
    });

    // Setup modal listeners
    setupModalListeners();

    (async function handleURLParams() {
      const u = new URL(window.location.href);
      const data = u.searchParams.get('data');
      const title = u.searchParams.get('title');
      const csvUrl = u.searchParams.get('csv');
      const analogiesUrl = u.searchParams.get('analogies');

      if (title) datasetTitleEl.textContent = `· ${decodeURIComponent(title)}`;

      // Load CSV from URL if provided
      if (csvUrl) {
        try {
          const resp = await fetch(csvUrl);
          if (resp.ok) {
            const text = await resp.text();
            const rows = parseCSV(text);
            loadCSVData(rows);
          } else {
            showError('Failed to fetch CSV: ' + resp.status);
          }
        } catch (e) {
          showError('Failed to fetch CSV. CORS or network blocked.');
        }
      }

      // Load analogies from URL if provided
      if (analogiesUrl) {
        try {
          const resp = await fetch(analogiesUrl);
          if (resp.ok) {
            const json = await resp.json();
            loadAnalogiesData(json);
          } else {
            showError('Failed to fetch analogies: ' + resp.status);
          }
        } catch (e) {
          showError('Failed to fetch analogies. CORS or network blocked.');
        }
      }

      // Load main data
      if (data) loadFromURL(data);
    })();

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') stopPlay(); });

    // Initial map/charts placeholders
    ensureMap();
    if (!chartStories) ensureCharts();
  </script>
</body>
</html>
